<!DOCTYPE html>
<html lang="en">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Techrocks Blog</title>
        <link rel="stylesheet" href="../style.css" />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Jacquard+24&family=Noto+Sans+Mono:wght@100..900&display=swap"
            rel="stylesheet"
        />
        <link rel="preconnect" href="https://fonts.googleapis.com" />
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
        <link
            href="https://fonts.googleapis.com/css2?family=Courier+Prime:ital,wght@0,400;0,700;1,400;1,700&display=swap"
            rel="stylesheet"
        />
    </head>
    <body>
        <main>
            <div>
                <div class="container">
                    <div class="border">
                        <header>Techrocks Blog</header>
                    </div>
                    <br />
                    <div class="content border">
                        <div class="header">Back</div>
                        <div style="margin-top: 10px" class="directory">
                            <a href="/">- Back to Home</a>
                        </div>
                    </div>
                </div>

                <div class="container" style="margin-top: 1rem">
                    <div class="border"><h1>Building Reliable Embedded Cloud Integrations with MQTT</h1>
<p>By FerretCode</p>
<h2>The Problem</h2>
<p>In applications that require multiple embedded devices, synchronization, management, and communication between them can be a challenge. In addition, the need for coordination and data aggregation grows when building end-to-end applications that combine both embedded devices and cloud services. Reliability is also a concern in such applications, since dropping data or failing to reach a device is undesirable.</p>
<h2>How MQTT can be a Good Fit</h2>
<p>MQTT is a messaging protocol for embedded applications that follows a pub-sub architecture that's designed for IoT applications and low-bandwidth/power applications. Clients (the devices in this case) generally publish messages to a central broker under different &quot;topics,&quot; which are then routed to other clients subscribed to that topic. Moreover, MQTT is bidirectional, meaning devices can both listen and subscribe to interested topics.</p>
<p>Firstly, MQTT is a lightweight protocol which is simple to implement in code and requires little processing power, meaning it's suitable for resource-constrained environments. It's also scalable and efficient--payloads are often small, and both the protocol and many brokers alike are designed to handle lots of connected devices. Finally, MQTT brokers can be configured with several authentication methods like username/password or client certificate auth.</p>
<p>Furthermore, one of MQTTs draws is reliability. The protocol supports several reliability features that are designed to ensure messages are delivered even over unreliable networks.</p>
<p>The distributed nature of MQTT, its pub-sub architecture, and its focus on resource efficiency and reliability make it a good fit for multi-device and end-to-end embedded applications.</p>
<h2>MQTT's Reliability Features in Detail</h2>
<p>One of MQTT's main reliability mechanisms is the use of Quality of Service (QoS) levels and functionality. MQTT exposes three QoS levels which all allow a tradeoff between reliability and overhead:</p>
<ul>
<li>QoS Level 0:
<ul>
<li>Guarantees &quot;at most once&quot; transmission</li>
<li>Fire &amp; Forget</li>
<li>No <code>ACK/NACK</code></li>
<li>Delivery is not guaranteed</li>
<li>Best in scenarios where readings or data are not critical, or in high-frequency data collection where occasional losses are acceptable</li>
</ul>
</li>
<li>QoS Level 1:
<ul>
<li>Guarantees &quot;at least once&quot; transmission</li>
<li>Guarantees the message arrives, but duplicates may occur</li>
<li>Sender resends the message until a <code>PUBACK</code> acknowledgement message is received</li>
<li>Best used when transmitting important data where delivery is crucial but duplicates are acceptable</li>
</ul>
</li>
<li>QoS Level 2:
<ul>
<li>Guarantees &quot;exactly once&quot; transmission</li>
<li>Best guarantee of reliability, since it ensures a message is always delivered exactly once</li>
<li>Uses a four-step handshake to confirm delivery</li>
<li>Best used for mission critical data or commands where loss OR duplication is unacceptable</li>
</ul>
</li>
</ul>
<p>These QoS levels are the first step in building a reliable message delivery flow. Additionally, MQTT also has other reliability mechanisms; one of which is persistent sessions.</p>
<p>When using persistent sessions, when a client connects the broker stores client's subscriptions, and queues missed QoS 1 and 2 messages while the client is offline. When that same client reconnects, the broker will deliver the queued messages, ensuring no data is lost during temporary disconnections.</p>
<p>Additionally, the use of the &quot;Keep Alive&quot; functionality helps detect abnormal disconnections. Each client periodically sends a <code>PINGREQ</code> packet to the broker to indicate that it's online. If the broker doesn't receive a message or <code>PINGREQ</code> within a specified interval, it can close the connection, and then use the final reliability mechanism:</p>
<p>Last Will and Testament (LWT) is a mechanism where clients can specify a &quot;will&quot; message during connection. If the client doesn't gracefully disconnect (e.g., due to a network failure), the broker will automatically publish that predefined message to a specified topic, allowing other clients to be aware of the disconnection.</p>
<p>When using all of these reliability mechanisms that MQTT provides, it allows for high reliability systems that support varying network conditions and device priorities.</p>
<h1>Example Device &lt;-&gt; Cloud Integration using RP2040, MQTT, EMQX, C, and Go</h1>
<p>Several months ago, I built a prototype embedded device based on the RPi Pico W using the C SDK that talked to a cloud backend and displayed information on the frontend using MQTT.</p>
<p>This project used an RFID tag reader for warehouse inventory tracking and management. One of the device's functions was to assist the dashboard in mapping new RFID tags to items. The dashboard would create a new item in its database, and over MQTT send the device basic information about the item. The device would then display the item on an OLED and allow the operator to scan an RFID tag that would be associated with that item upon warehouse ingress or egress.</p>
<p>The first step in building the communication flow between the device and the cloud is to initialize an MQTT client and create the connection to the broker. For this project, since I was using the RPi Pico W, I was able to use the LwIP TCP/IP stack, which on top of basic TCP/IP support implements application layer protocols, including MQTT. The general broker connection flow on the Pico looks like:</p>
<ol>
<li>Initialize WiFi on the Pico's CYW43 wireless chip</li>
<li>Connect to a network</li>
<li>Create the MQTT client by initializing some state and creating the LwIP client object</li>
<li>Run a DNS lookup on the EMQX instance hostname</li>
<li>Attempt a connection with the broker</li>
</ol>
<p>In practice, the high-level initialization function looked like:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span>MQTT_CLIENT_T<span style="color:#f92672">*</span> <span style="color:#a6e22e">init_mqtt</span>(<span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> ssid, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> pw, <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> broker_hostname, u16_t broker_port, <span style="color:#66d9ef">int</span> timeout)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> wifi_init_result <span style="color:#f92672">=</span> cyw43_arch_init();
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (wifi_init_result) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Failed to initialize MQTT. Init result: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, wifi_init_result);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">while</span> (<span style="color:#f92672">!</span>cyw43_is_initialized(<span style="color:#f92672">&amp;</span>cyw43_state)) {
</span></span><span style="display:flex;"><span>        sleep_ms(<span style="color:#ae81ff">1</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cyw43_arch_enable_sta_mode();
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    sleep_ms(<span style="color:#ae81ff">2000</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Connecting to WiFi with credentials ssid=%s, pw=%s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, ssid, pw);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> connection_result <span style="color:#f92672">=</span> cyw43_arch_wifi_connect_timeout_ms(
</span></span><span style="display:flex;"><span>        ssid, pw, CYW43_AUTH_WPA2_AES_PSK, timeout);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (connection_result) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Failed to connect to WiFi. Connection result: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, connection_result);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">switch</span> (connection_result) {
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> PICO_ERROR_BADAUTH:
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Error authenticating to WiFi network</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> PICO_ERROR_TIMEOUT:
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Timeout authenticating to WiFi network</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">case</span> PICO_ERROR_CONNECT_FAILED:
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Other error connecting to WiFi network</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">break</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> NULL;
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Connected to WiFi</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    MQTT_CLIENT_T<span style="color:#f92672">*</span> state <span style="color:#f92672">=</span> mqtt_client_init(broker_port);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">int</span> res <span style="color:#f92672">=</span> run_dns_lookup(state, broker_hostname);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (res <span style="color:#f92672">==</span> DNS_ERR) {
</span></span><span style="display:flex;"><span>        state<span style="color:#f92672">-&gt;</span>err <span style="color:#f92672">=</span> DNS_ERR;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    state<span style="color:#f92672">-&gt;</span>mqtt_client <span style="color:#f92672">=</span> mqtt_client_new();
</span></span><span style="display:flex;"><span>    state<span style="color:#f92672">-&gt;</span>counter <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (state<span style="color:#f92672">-&gt;</span>mqtt_client <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Failed to create new MQTT client</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        state<span style="color:#f92672">-&gt;</span>err <span style="color:#f92672">=</span> MQTT_ERR;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    res <span style="color:#f92672">=</span> mqtt_connect(state);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (res <span style="color:#f92672">!=</span> ERR_OK) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Error connecting to MQTT broker</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        state<span style="color:#f92672">-&gt;</span>err <span style="color:#f92672">=</span> res;
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">return</span> state;
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">return</span> state;
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h3>Note: the LwIP MQTT implementation does not support persistent sessions, so this project just relied on the device being connected to the broker when we needed to register new items.</h3>
<p>Once a connection is made with the broker, the next step was to subscribe to the &quot;incoming items&quot; topic such that we could listen for new items to be registered:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">subscribe_incoming_items</span>(MQTT_CLIENT_T<span style="color:#f92672">*</span> state, Task<span style="color:#f92672">**</span> head)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    mqtt_set_inpub_callback(
</span></span><span style="display:flex;"><span>        state<span style="color:#f92672">-&gt;</span>mqtt_client,
</span></span><span style="display:flex;"><span>        NULL,
</span></span><span style="display:flex;"><span>        process_incoming_item_data,
</span></span><span style="display:flex;"><span>        head);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (mqtt_client_is_connected(state<span style="color:#f92672">-&gt;</span>mqtt_client) <span style="color:#f92672">==</span> <span style="color:#ae81ff">1</span>) {
</span></span><span style="display:flex;"><span>        mqtt_subscribe(
</span></span><span style="display:flex;"><span>            state<span style="color:#f92672">-&gt;</span>mqtt_client,
</span></span><span style="display:flex;"><span>            SUB_TOPIC,
</span></span><span style="display:flex;"><span>            <span style="color:#ae81ff">1</span>,
</span></span><span style="display:flex;"><span>            subscribed_topic,
</span></span><span style="display:flex;"><span>            NULL);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;MQTT client is not connected.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">subscribed_topic</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg, err_t err)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    printf(<span style="color:#e6db74">&#34;Subscription callback triggered</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (err <span style="color:#f92672">!=</span> ERR_OK) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Error subscribing. Err: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, err);
</span></span><span style="display:flex;"><span>    } <span style="color:#66d9ef">else</span> {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Successfully subscribed.</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>With the subscription created, new messages sent by the dashboard would trigger this callback, which would parse a JSON payload and push it onto a linked-list-based item queue for display and processing:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">process_incoming_item_data</span>(<span style="color:#66d9ef">void</span><span style="color:#f92672">*</span> arg, <span style="color:#66d9ef">const</span> u8_t<span style="color:#f92672">*</span> data, u16_t total_len, u8_t flags)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">if</span> (flags <span style="color:#f92672">&amp;</span> MQTT_DATA_FLAG_LAST) {
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;New item to register!</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;Received Length: %d</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, total_len);
</span></span><span style="display:flex;"><span>        printf(<span style="color:#e6db74">&#34;MQTT Payload: %.*s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, total_len, (<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)data);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>arg) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Failed to process item</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        Task<span style="color:#f92672">**</span> head <span style="color:#f92672">=</span> (Task<span style="color:#f92672">**</span>)arg;
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        ITEM_T<span style="color:#f92672">*</span> item <span style="color:#f92672">=</span> (ITEM_T<span style="color:#f92672">*</span>)malloc(<span style="color:#66d9ef">sizeof</span>(ITEM_T));
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cJSON<span style="color:#f92672">*</span> json <span style="color:#f92672">=</span> cJSON_Parse((<span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span>)data);
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (json <span style="color:#f92672">==</span> NULL) {
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> err_ptr <span style="color:#f92672">=</span> cJSON_GetErrorPtr();
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">if</span> (err_ptr <span style="color:#f92672">!=</span> NULL) {
</span></span><span style="display:flex;"><span>                printf(<span style="color:#e6db74">&#34;Error parsing JSON payload: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, err_ptr);
</span></span><span style="display:flex;"><span>            }
</span></span><span style="display:flex;"><span>            cJSON_Delete(json);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cJSON<span style="color:#f92672">*</span> item_id <span style="color:#f92672">=</span> cJSON_GetObjectItemCaseSensitive(json, <span style="color:#e6db74">&#34;item_id&#34;</span>);
</span></span><span style="display:flex;"><span>        cJSON<span style="color:#f92672">*</span> tag_quantity <span style="color:#f92672">=</span> cJSON_GetObjectItemCaseSensitive(json, <span style="color:#e6db74">&#34;tag_quantity&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cJSON_IsNumber(item_id) <span style="color:#f92672">||</span> <span style="color:#f92672">!</span>cJSON_IsNumber(tag_quantity)) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Invalid JSON payload format</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            cJSON_Delete(item_id);
</span></span><span style="display:flex;"><span>            cJSON_Delete(tag_quantity);
</span></span><span style="display:flex;"><span>            cJSON_Delete(json);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        cJSON<span style="color:#f92672">*</span> item_name <span style="color:#f92672">=</span> cJSON_GetObjectItemCaseSensitive(json, <span style="color:#e6db74">&#34;item_name&#34;</span>);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        <span style="color:#66d9ef">if</span> (<span style="color:#f92672">!</span>cJSON_IsString(item_name)) {
</span></span><span style="display:flex;"><span>            printf(<span style="color:#e6db74">&#34;Invalid JSON payload format</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>);
</span></span><span style="display:flex;"><span>            cJSON_Delete(item_id);
</span></span><span style="display:flex;"><span>            cJSON_Delete(tag_quantity);
</span></span><span style="display:flex;"><span>            cJSON_Delete(json);
</span></span><span style="display:flex;"><span>            cJSON_Delete(item_name);
</span></span><span style="display:flex;"><span>            <span style="color:#66d9ef">return</span>;
</span></span><span style="display:flex;"><span>        }
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        item<span style="color:#f92672">-&gt;</span>item_id <span style="color:#f92672">=</span> cJSON_GetNumberValue(item_id);
</span></span><span style="display:flex;"><span>        item<span style="color:#f92672">-&gt;</span>tag_quantity <span style="color:#f92672">=</span> cJSON_GetNumberValue(tag_quantity);
</span></span><span style="display:flex;"><span>        item<span style="color:#f92672">-&gt;</span>item_name <span style="color:#f92672">=</span> cJSON_GetStringValue(item_name);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>        enqueue_task(head, item);
</span></span><span style="display:flex;"><span>    }
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>Finally, as items were pulled from the queue they would be displayed onto an OLED for the operator to read, then scan the associated tag, and finally press a button that tells the cloud backend what the tag's ID was:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">void</span> <span style="color:#a6e22e">publish_item_registered</span>(MQTT_CLIENT_T<span style="color:#f92672">*</span> state, ITEM_T<span style="color:#f92672">*</span> item)
</span></span><span style="display:flex;"><span>{
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">// encode the item as JSON
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>    cJSON<span style="color:#f92672">*</span> root <span style="color:#f92672">=</span> cJSON_CreateObject();
</span></span><span style="display:flex;"><span>    cJSON_AddNumberToObject(root, <span style="color:#e6db74">&#34;item_id&#34;</span>, item<span style="color:#f92672">-&gt;</span>item_id);
</span></span><span style="display:flex;"><span>    cJSON_AddNumberToObject(root, <span style="color:#e6db74">&#34;tag_quantity&#34;</span>, item<span style="color:#f92672">-&gt;</span>tag_quantity);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span> hexTag[<span style="color:#ae81ff">5</span>];
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    bytes_to_hex(item<span style="color:#f92672">-&gt;</span>tag, <span style="color:#66d9ef">sizeof</span>(item<span style="color:#f92672">-&gt;</span>tag), hexTag);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    cJSON_AddStringToObject(root, <span style="color:#e6db74">&#34;tag&#34;</span>, hexTag);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    <span style="color:#66d9ef">char</span><span style="color:#f92672">*</span> json_str <span style="color:#f92672">=</span> cJSON_Print(root);
</span></span><span style="display:flex;"><span>    cJSON_Delete(root);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    mqtt_publish(state<span style="color:#f92672">-&gt;</span>mqtt_client, PUB_TOPIC, json_str, strlen(json_str), <span style="color:#ae81ff">1</span>, <span style="color:#ae81ff">0</span>, NULL, NULL);
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    free(item);
</span></span><span style="display:flex;"><span>    free(json_str);
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>On the backend, the flow looked something like this:</p>
<ol>
<li>When requested by an operator, create a new item in the database and publish it to the &quot;item registration&quot; topic</li>
<li>Listen for a response from the &quot;item registered&quot; topic and update the associated item in the database.</li>
</ol>
<p>Here is what the item publishing looked like on the backend:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> <span style="color:#a6e22e">CreateItem</span>(<span style="color:#a6e22e">w</span> <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">ResponseWriter</span>, <span style="color:#a6e22e">r</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Request</span>, <span style="color:#a6e22e">ctx</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">RequestContext</span>) <span style="color:#66d9ef">error</span> {
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">var</span> <span style="color:#a6e22e">item</span> <span style="color:#a6e22e">repositories</span>.<span style="color:#a6e22e">CreateItemParams</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">ParseForm</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Name</span> = <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullString</span>{<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PostFormValue</span>(<span style="color:#e6db74">&#34;name&#34;</span>), <span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Category</span> = <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullString</span>{<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PostFormValue</span>(<span style="color:#e6db74">&#34;category&#34;</span>), <span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">item</span>.<span style="color:#a6e22e">Sku</span> = <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullString</span>{<span style="color:#a6e22e">r</span>.<span style="color:#a6e22e">PostFormValue</span>(<span style="color:#e6db74">&#34;sku&#34;</span>), <span style="color:#66d9ef">true</span>}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Begin</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Rollback</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Repositories</span>.<span style="color:#a6e22e">WithTx</span>(<span style="color:#a6e22e">tx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">newItem</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">qtx</span>.<span style="color:#a6e22e">CreateItem</span>(<span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">Ctx</span>, <span style="color:#a6e22e">item</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Commit</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">messagePayload</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">ItemRegistrationPaylod</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ItemId</span>:      <span style="color:#a6e22e">newItem</span>.<span style="color:#a6e22e">ID</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">ItemName</span>:    <span style="color:#a6e22e">newItem</span>.<span style="color:#a6e22e">Name</span>.<span style="color:#a6e22e">String</span>,
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">TagQuantity</span>: <span style="color:#ae81ff">100</span>, <span style="color:#75715e">// TODO: make this variable
</span></span></span><span style="display:flex;"><span><span style="color:#75715e"></span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">stringified</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Marshal</span>(<span style="color:#a6e22e">messagePayload</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">token</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">ctx</span>.<span style="color:#a6e22e">MQTTConn</span>.<span style="color:#a6e22e">Publish</span>(<span style="color:#e6db74">&#34;item_registration&#34;</span>, <span style="color:#ae81ff">1</span>, <span style="color:#66d9ef">false</span>, <span style="color:#a6e22e">stringified</span>)
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Wait</span>() <span style="color:#f92672">&amp;&amp;</span> <span style="color:#a6e22e">token</span>.<span style="color:#a6e22e">Error</span>() <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span> <span style="color:#a6e22e">err</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">Redirect</span>(<span style="color:#a6e22e">w</span>, <span style="color:#a6e22e">r</span>, <span style="color:#e6db74">&#34;/dashboard/items&#34;</span>, <span style="color:#a6e22e">http</span>.<span style="color:#a6e22e">StatusFound</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">return</span> <span style="color:#66d9ef">nil</span>
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><p>And here is what the item updating looked like:</p>
<pre tabindex="0" style="color:#f8f8f2;background-color:#272822;"><code><span style="display:flex;"><span><span style="color:#66d9ef">func</span> (<span style="color:#a6e22e">h</span> <span style="color:#f92672">*</span><span style="color:#a6e22e">MQTTHandler</span>) <span style="color:#a6e22e">CreateTag</span>(<span style="color:#a6e22e">client</span> <span style="color:#a6e22e">mqtt</span>.<span style="color:#a6e22e">Client</span>, <span style="color:#a6e22e">msg</span> <span style="color:#a6e22e">mqtt</span>.<span style="color:#a6e22e">Message</span>) {
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">createTagRequest</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">types</span>.<span style="color:#a6e22e">CreateTagRequest</span>{}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">json</span>.<span style="color:#a6e22e">Unmarshal</span>(<span style="color:#a6e22e">msg</span>.<span style="color:#a6e22e">Payload</span>(), <span style="color:#f92672">&amp;</span><span style="color:#a6e22e">createTagRequest</span>); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;error decoding payload&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Info</span>(<span style="color:#e6db74">&#34;new item finished registration&#34;</span>, <span style="color:#e6db74">&#34;request&#34;</span>, <span style="color:#a6e22e">createTagRequest</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">tx</span>, <span style="color:#a6e22e">err</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">DB</span>.<span style="color:#a6e22e">Begin</span>()
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;error opening database transaction&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">defer</span> <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Rollback</span>()
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">qtx</span> <span style="color:#f92672">:=</span> <span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Repositories</span>.<span style="color:#a6e22e">WithTx</span>(<span style="color:#a6e22e">tx</span>)
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#a6e22e">_</span>, <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">qtx</span>.<span style="color:#a6e22e">CreateTag</span>(<span style="color:#f92672">*</span><span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Ctx</span>, <span style="color:#a6e22e">repositories</span>.<span style="color:#a6e22e">CreateTagParams</span>{
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Uid</span>:      <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullString</span>{<span style="color:#a6e22e">createTagRequest</span>.<span style="color:#a6e22e">Uid</span>, <span style="color:#66d9ef">true</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Item</span>:     <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullInt64</span>{<span style="color:#a6e22e">createTagRequest</span>.<span style="color:#a6e22e">ItemId</span>, <span style="color:#66d9ef">true</span>},
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">Quantity</span>: <span style="color:#a6e22e">sql</span>.<span style="color:#a6e22e">NullInt64</span>{<span style="color:#a6e22e">createTagRequest</span>.<span style="color:#a6e22e">Quantity</span>, <span style="color:#66d9ef">true</span>},
</span></span><span style="display:flex;"><span>	})
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;error creating tag&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>	<span style="color:#66d9ef">if</span> <span style="color:#a6e22e">err</span> = <span style="color:#a6e22e">tx</span>.<span style="color:#a6e22e">Commit</span>(); <span style="color:#a6e22e">err</span> <span style="color:#f92672">!=</span> <span style="color:#66d9ef">nil</span> {
</span></span><span style="display:flex;"><span>		<span style="color:#a6e22e">h</span>.<span style="color:#a6e22e">Logger</span>.<span style="color:#a6e22e">Error</span>(<span style="color:#e6db74">&#34;error committing database transaction&#34;</span>, <span style="color:#e6db74">&#34;err&#34;</span>, <span style="color:#a6e22e">err</span>)
</span></span><span style="display:flex;"><span>		<span style="color:#66d9ef">return</span>
</span></span><span style="display:flex;"><span>	}
</span></span><span style="display:flex;"><span>}
</span></span></code></pre><h1>Why MQTT Was Useful in This Project (and why it can be in yours too)</h1>
<p>MQTT was a good choice in this project--its pub-sub architecture and distributed nature made the application scalable up to many devices. After item registration, operators also need to be able to use the scanner to view the inventory of items in the warehouse. With many operators (and therefore devices) that may be working at once, having a protocol that was robust enough not to drop packets in an environment where network connectivity may be limited and could support many communications at once was imperative.</p>
<p>For this project, I used QoS level 1, and the communication was reliable for what I needed it to be. It was a shame that LwIP couldn't support persistent sessions, but when connection was stable, packets were always delivered reliably.</p>
<p>Additionally, MQTT was a good fit for this project since it allowed the backend to update in real-time with fresh data from multiple sensor boards, and allowed device management remotely via the frontend.</p>
<p>For similar reasons, MQTT may be useful in your project--if you need an application layer protocol that is reliable, distributed, and allows for communication, management, and synchronization, MQTT is a good fit.</p>
</div>
                </div>
            </div>
        </main>
    </body>
</html>
